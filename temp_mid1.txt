    setEditWillingDesignProject(false)
    setEditInteractionType('')
    setEditHasGuide(false)
    setEditCanReceiveAlternance(false)
    setEditQuotaStr('')
  }

  function handleEditNameChange(v: string) {
    setEditName(v)
    const name = v.trim().toLowerCase()
    const c = companies.find((x) => x.name.trim().toLowerCase() === name)
    if (c) setEditSector(String(c.sector || ''))
    const existing = getProspects().find(
      (p) => (p.company_name || '').trim().toLowerCase() === name,
    )
    if (existing) {
      setEditInterest(!!existing.interest_collaborate)
      setEditWorkedBefore(!!existing.worked_before)
      setEditCanDevelopActivities(!!existing.can_develop_activities)
      setEditWillingDesignProject(!!existing.willing_design_project)
      setEditInteractionType(existing.interaction_type || '')
      setEditHasGuide(!!existing.has_guide)
      setEditCanReceiveAlternance(!!existing.can_receive_alternance)
      setEditQuotaStr(
        typeof existing.alternance_students_quota === 'number'
          ? String(existing.alternance_students_quota)
          : ''
      )
    }
  }

  function saveEdit() {
    const name = editName.trim()
    const sector = editSector.trim()
    if (!name) {
      alert('Ingrese el nombre de la contraparte')
      return
    }
    const arr = getProspects()
    const idx = editing ? arr.findIndex((x) => x.id === editing.id) : -1

    const candidate = companies.find(
      (c) => c.name.trim().toLowerCase() === name.toLowerCase(),
    )
    const resp = candidate?.spys_responsible_name?.trim() || ''

    const record: Prospect = {
      id: editing?.id || crypto.randomUUID(),
      company_name: name,
      sector,
      responsible_name: resp || editing?.responsible_name,
      interest_collaborate: !!editInterest,
      worked_before: !!editWorkedBefore,
      can_develop_activities: !!editCanDevelopActivities,
      willing_design_project: !!editWillingDesignProject,
      interaction_type: editInteractionType,
      has_guide: !!editHasGuide,
      can_receive_alternance: !!editCanReceiveAlternance,
      alternance_students_quota:
        editCanReceiveAlternance && editQuotaStr !== ''
          ? Math.max(0, parseInt(editQuotaStr || '0', 10) || 0)
          : null,
    }

    if (idx >= 0) {
      arr[idx] = { ...arr[idx], ...record }
      toast.success('Contraparte actualizada')
    } else {
      arr.push(record)
      toast.success('Contraparte creada')
    }
    localStorage.setItem('vcm_posibles_contrapartes', JSON.stringify(arr))
    setItems(arr)

    // Si hay asignatura seleccionada y la empresa existe, guarda en BD como CompanyRequirement
    try {
      if (editSubjectId) {
        const company = companies.find(
          (c) => c.name.trim().toLowerCase() === record.company_name.trim().toLowerCase(),
        )
        if (company) {
          await createCompanyRequirement({
            subject: editSubjectId,
            company: company.id,
            sector: record.sector || '',
            worked_before: !!record.worked_before,
            interest_collaborate: !!record.interest_collaborate,
            can_develop_activities: !!record.can_develop_activities,
            willing_design_project: !!record.willing_design_project,
            interaction_type: record.interaction_type || '',
            has_guide: !!record.has_guide,
            can_receive_alternance: !!record.can_receive_alternance,
            alternance_students_quota: record.can_receive_alternance ? (record.alternance_students_quota ?? null) : null,
          })
          toast.success('Guardado en base de datos')
        } else {
          toast.error('Empresa no encontrada en BD. Cree la empresa primero.')
        }
      }
    } catch (e) {
      toast.error(e instanceof Error ? e.message : 'No se pudo guardar en BD')
    } finally {
      setEditing(null)
    }
  }

  function onDelete(p: Prospect) {
    if (!confirm(`¿Eliminar "${p.company_name}" de posibles contrapartes?`)) return
    const arr = getProspects().filter((x) => x.id !== p.id)
    localStorage.setItem('vcm_posibles_contrapartes', JSON.stringify(arr))
    setItems(arr)
    toast.success('Contraparte eliminada')
  }

  return (
    <section className="p-6">
      <div className="mb-4 flex items-center justify-between">
        <h1 className="text-xl font-semibold">Posible contraparte</h1>
        <button
          onClick={openCreate}
          className="rounded-md bg-red-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-red-700"
        >
          Nueva contraparte
        </button>
      </div>

      {error ? (
        <div className="mb-3 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">{error}</div>
      ) : null}

      <div className="overflow-x-auto rounded-lg border border-zinc-200 bg-white">
        <table className="min-w-full divide-y divide-zinc-200">
          <thead className="bg-zinc-50">
            <tr>
              <Th className="uppercase tracking-wide">Empresa</Th>
              <Th className="uppercase tracking-wide">Sector</Th>
              <Th className="uppercase tracking-wide">Interés</Th>
              <Th className="uppercase tracking-wide">Responsable</Th>
              <Th className="text-right uppercase tracking-wide">Acciones</Th>
            </tr>
          </thead>
          <tbody className="divide-y divide-zinc-100 bg-white">
            {loading ? (
              <tr><td className="p-4 text-sm text-zinc-600" colSpan={5}>Cargando…</td></tr>
            ) : items.length === 0 ? (
              <tr><td className="p-4 text-sm text-zinc-600" colSpan={5}>Sin registros</td></tr>
            ) : (
              items.map((r) => (
                <tr key={r.id} className="hover:bg-zinc-50">
                  <Td>{r.company_name || '—'}</Td>
